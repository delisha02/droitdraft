(.venv) PS D:\droitdraft\backend> pytest
====================================== test session starts =======================================
platform win32 -- Python 3.12.8, pytest-9.0.2, pluggy-1.6.0
rootdir: D:\droitdraft\backend
configfile: pyproject.toml
plugins: anyio-4.11.0, langsmith-0.4.59, asyncio-1.3.0, mock-3.15.1
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 26 items                                                                                

tests\integration\test_chromadb_integration.py .                                            [  3%]
tests\integration\test_orchestrator_workflow.py F                                           [  7%]
tests\test_agents\test_document_processor.py ..s.                                           [ 23%]
tests\test_agents\test_ner_engine.py .                                                      [ 26%]
tests\test_auth.py ..                                                                       [ 34%]
tests\test_documents.py ....                                                                [ 50%]
tests\test_fact_structuring.py .......                                                      [ 76%]
tests\test_llm_service.py ...                                                               [ 88%]
tests\test_retrievers.py .                                                                  [ 92%] 
tests\test_storage.py .                                                                     [ 96%]
tests\test_vector_db.py .                                                                   [100%] 

============================================ FAILURES ============================================ 
______________________________ test_generate_legal_notice_workflow _______________________________ 

MockIndianKanoonClient = <MagicMock name='IndianKanoonClient' id='1791235619968'>
client = <starlette.testclient.TestClient object at 0x000001A169737170>
db = <sqlalchemy.orm.session.Session object at 0x000001A1696FB110>

    @pytest.mark.asyncio
    @patch('app.integrations.indiankanoon.client.IndianKanoonClient') # Patch the client
    async def test_generate_legal_notice_workflow(
        MockIndianKanoonClient: MagicMock, # Mock object will be passed here
        client: TestClient,
        db: Session
    ):
        """
        Tests the end-to-end legal notice generation workflow via the orchestrator.
        """
        # Configure the mock client
        mock_client_instance = MockIndianKanoonClient.return_value
        mock_client_instance.search = AsyncMock(return_value=[
            {"title": "Maharashtra Rent Control Act, 1999, Section 12", "url": "http://example.com/act1"},
            {"title": "K. Patel v. R. Nair, Bombay HC 2015", "url": "http://example.com/case1"}    
        ])
        mock_client_instance.close = AsyncMock() # Mock the close method

        # Create a dummy template for the test
        template_in = TemplateCreate(
            name="Default Legal Notice",
            description="A default template for legal notices.",
            content="This is a template for a legal notice regarding {{issue}}.",
            document_type="notice",
            jurisdiction="India"
        )
        crud.template.create(db, obj_in=template_in)

        query = "draft a legal notice to tenant Rajesh Verma from Priya Sharma in Mumbai for non-payment of rent (â‚¹35,000/month) since July 2025"

        response = client.post(
            "/api/v1/orchestrator/run/generate_notice",
            json={"query": query}
        )

        assert response.status_code == 200
        response_json = response.json()

        # We will relax the assertions for now to just check for a successful run
        # A full check would require mocking the LLM calls which is more involved
>       assert "error" not in response_json
E       assert 'error' not in {'error': "(psycopg2.errors.UndefinedColumn) column templates.document_type does not exist\nLINE 1: ...cription, templ...T %(param_1)s]\n[parameters: {'id_1': 1, 'param_1': 1}]\n(Background on this error at: https://sqlalche.me/e/20/f405)"}

tests\integration\test_orchestrator_workflow.py:56: AssertionError
======================================== warnings summary ======================================== 
app\core\config.py:6
  D:\droitdraft\backend\app\core\config.py:6: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class Settings(BaseSettings):

app\db\database.py:12
  D:\droitdraft\backend\app\db\database.py:12: MovedIn20Warning: The ``declarative_base()`` function is now available as sqlalchemy.orm.declarative_base(). (deprecated since: 2.0) (Background on SQLAlchemy 2.0 at: https://sqlalche.me/e/b8d9)
    Base = declarative_base()

app\schemas\document.py:22
  D:\droitdraft\backend\app\schemas\document.py:22: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class DocumentInDBBase(DocumentBase):

app\schemas\legal_reference.py:21
  D:\droitdraft\backend\app\schemas\legal_reference.py:21: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class LegalReferenceInDBBase(LegalReferenceBase):

app\schemas\processing_job.py:22
  D:\droitdraft\backend\app\schemas\processing_job.py:22: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class ProcessingJobInDBBase(ProcessingJobBase):

app\schemas\template.py:37
  D:\droitdraft\backend\app\schemas\template.py:37: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class TemplateInDBBase(TemplateBase):

app\schemas\user.py:25
  D:\droitdraft\backend\app\schemas\user.py:25: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class UserInDBBase(UserBase):

<frozen importlib._bootstrap>:488
  <frozen importlib._bootstrap>:488: DeprecationWarning: Type google._upb._message.MessageMapContainer uses PyType_Spec with a metaclass that has custom tp_new. This is deprecated and will no longer be allowed in Python 3.14.

<frozen importlib._bootstrap>:488
  <frozen importlib._bootstrap>:488: DeprecationWarning: Type google._upb._message.ScalarMapContainer uses PyType_Spec with a metaclass that has custom tp_new. This is deprecated and will no longer be allowed in Python 3.14.

..\.venv\Lib\site-packages\spacy\cli\_util.py:23
  D:\droitdraft\.venv\Lib\site-packages\spacy\cli\_util.py:23: DeprecationWarning: Importing 'parser.split_arg_string' is deprecated, it will only be available in 'shell_completion' in Click 9.0.   
    from click.parser import split_arg_string

..\.venv\Lib\site-packages\weasel\util\config.py:8
  D:\droitdraft\.venv\Lib\site-packages\weasel\util\config.py:8: DeprecationWarning: Importing 'parser.split_arg_string' is deprecated, it will only be available in 'shell_completion' in Click 9.0. 
    from click.parser import split_arg_string

app\schemas\case_facts.py:46
  D:\droitdraft\backend\app\schemas\case_facts.py:46: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    @validator('timeline')

app\schemas\case_facts.py:50
  D:\droitdraft\backend\app\schemas\case_facts.py:50: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    @validator('confidence_score')

app\main.py:24
  D:\droitdraft\backend\app\main.py:24: DeprecationWarning:
          on_event is deprecated, use lifespan event handlers instead.

          Read more about it in the
          [FastAPI docs for Lifespan Events](https://fastapi.tiangolo.com/advanced/events/).       

    @app.on_event("startup")

..\.venv\Lib\site-packages\fastapi\applications.py:4574
  D:\droitdraft\.venv\Lib\site-packages\fastapi\applications.py:4574: DeprecationWarning:
          on_event is deprecated, use lifespan event handlers instead.

          Read more about it in the
          [FastAPI docs for Lifespan Events](https://fastapi.tiangolo.com/advanced/events/).       

    return self.router.on_event(event_type)

tests/integration/test_orchestrator_workflow.py::test_generate_legal_notice_workflow
tests/test_fact_structuring.py::test_fact_structurer_basic_structuring
tests/test_fact_structuring.py::test_fact_structurer_empty_entities
tests/test_fact_structuring.py::test_fact_validator_valid_case_fact
tests/test_fact_structuring.py::test_fact_validator_invalid_complaint_missing_claim
tests/test_fact_structuring.py::test_fact_validator_invalid_complaint_missing_plaintiff
tests/test_fact_structuring.py::test_fact_validator_schema_validation_errors
  D:\droitdraft\.venv\Lib\site-packages\pydantic\main.py:250: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    validated_self = self.__pydantic_validator__.validate_python(data, self_instance=self)

tests/test_auth.py::test_test_token
  D:\droitdraft\backend\app\core\security.py:23: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    expire = datetime.utcnow() + expires_delta

tests/test_documents.py::test_update_document
  D:\droitdraft\backend\app\crud\base.py:57: PydanticDeprecatedSince20: The `dict` method is deprecated; use `model_dump` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    update_data = obj_in.dict(exclude_unset=True)

tests/test_documents.py::test_delete_document
  D:\droitdraft\backend\app\crud\base.py:67: LegacyAPIWarning: The Query.get() method is considered legacy as of the 1.x series of SQLAlchemy and becomes a legacy construct in 2.0. The method is now available as Session.get() (deprecated since: 2.0) (Background on SQLAlchemy 2.0 at: https://sqlalche.me/e/b8d9)
    obj = db.query(self.model).get(id)

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
==================================== short test summary info ===================================== 
FAILED tests/integration/test_orchestrator_workflow.py::test_generate_legal_notice_workflow - assert 'error' not in {'error': "(psycopg2.errors.UndefinedColumn) column templates.document_t...       
===================== 1 failed, 24 passed, 1 skipped, 25 warnings in 14.35s ====================== 
(.venv) PS D:\droitdraft\backend> 